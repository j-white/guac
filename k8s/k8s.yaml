---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: guac-collectsub
spec:
  replicas: 1
  selector:
    matchLabels:
      app: guac-collectsub
  template:
    metadata:
      labels:
        app: guac-collectsub
    spec:
      containers:
        - name: guac-collectsub
          image: local-organic-guac
          command: ["/opt/guac/guaccsub"]
          workingDir: /tmp
          ports:
            - containerPort: 2782
          readinessProbe:
            exec:
              command:
                - wget
                - --spider
                - http://localhost:2782
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 10
            successThreshold: 1
            failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: guac-collectsub
spec:
  selector:
    app: guac-collectsub
  ports:
    - protocol: TCP
      port: 2782
      targetPort: 2782
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: guac-graphql
spec:
  replicas: 1
  selector:
    matchLabels:
      app: guac-graphql
  template:
    metadata:
      labels:
        app: guac-graphql
    spec:
      containers:
        - name: guac-graphql
          image: local-organic-guac
          command: ["/opt/guac/guacgql"]
          workingDir: /tmp
          env:
            - name: GUAC_GQL_DEBUG
              value: "true"
            - name: GUAC_GQL_TEST_DATA
              value: "true"
          ports:
            - name: http-port
              containerPort: 8080
            - name: debug-port
              containerPort: 5555
          readinessProbe:
            httpGet:
              path: /healthz
              port: http-port
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 10
            successThreshold: 1
            failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: guac-graphql
spec:
  selector:
    app: guac-graphql
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: guac-ingestor
spec:
  replicas: 1
  selector:
    matchLabels:
      app: guac-ingestor
  template:
    metadata:
      labels:
        app: guac-ingestor
    spec:
      containers:
        - name: guac-ingestor
          image: local-organic-guac
          command: ["/opt/guac/guacingest"]
          workingDir: /tmp
          env:
            - name: GUAC_NATS_ADDR
              value: nats://nats:4222
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: oci-collector
spec:
  replicas: 1
  selector:
    matchLabels:
      app: oci-collector
  template:
    metadata:
      labels:
        app: oci-collector
    spec:
      containers:
        - name: oci-collector
          image: local-organic-guac
          command: ["/opt/guac/guaccollect", "image"]
          workingDir: /tmp
          env:
            - name: GUAC_NATS_ADDR
              value: nats://nats:4222
            - name: GUAC_CSUB_ADDR
              value: guac-collectsub:2782
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: depsdev-collector
spec:
  replicas: 1
  selector:
    matchLabels:
      app: depsdev-collector
  template:
    metadata:
      labels:
        app: depsdev-collector
    spec:
      containers:
        - name: depsdev-collector
          image: local-organic-guac
          command: ["/opt/guac/guaccollect", "deps_dev"]
          workingDir: /tmp
          env:
            - name: GUAC_NATS_ADDR
              value: nats://nats:4222
            - name: GUAC_CSUB_ADDR
              value: guac-collectsub:2782
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: janusgraph
spec:
  replicas: 1
  selector:
    matchLabels:
      app: janusgraph
  template:
    metadata:
      labels:
        app: janusgraph
    spec:
      containers:
        - name: janusgraph
          image: janusgraph/janusgraph:1.0.0-20230721-184042.029b4d2-029b4d2
          env:
#            - name: JANUS_PROPS_TEMPLATE
#              value: "inmemory"
            - name: janusgraph.query.force-index
              value: "true"
            - name: gremlinserver.maxContentLength
              value: "6553600"
            - name: JAVA_OPTIONS
              value: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
          ports:
            - containerPort: 8182
              name: ws
            - containerPort: 5005
              name: java-debug
---
apiVersion: v1
kind: Service
metadata:
  name: janusgraph
spec:
  selector:
    app: janusgraph
  ports:
    - protocol: TCP
      port: 8182
      targetPort: 8182
  type: ClusterIP